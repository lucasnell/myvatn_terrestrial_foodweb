---
title: 'Supporting Information.'
subtitle: "``Transient top-down and bottom-up effects of resources pulsed to multiple trophic levels''"
date: ""
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{placeins}
    - \usepackage{cancel}
fontsize: 12pt
geometry: margin=1in,letterpaper
documentclass: article
graphics: true
colorlinks: true
supplemental: true
mathspec: true
output:
    bookdown::pdf_document2:
        fig_caption: yes
        template: template.tex
        latex_engine: xelatex
        number_sections: false
        dev: cairo_pdf
author:
    - name: Matthew A. McCary
      nums: "1,*,§"
    - name: Joseph S. Phillips
      nums: "2,†,§"
    - name: Tanjona Ramiadantsoa
      nums: "2"
    - name: Lucas A. Nell
      nums: "2"
    - name: Amanda R. McCormick
      nums: "2"
    - name: Jamieson C. Botsch
      nums: "2"
affil:
    - name: "Department of Entomology, University of Wisconsin, Madison, WI 53706, USA"
      num: "1"
    - name: "Department of Integrative Biology, University of Wisconsin, Madison, WI 53706, USA"
      num: "2"
    - name: "Corresponding author.  Email: matt.mccary@gmail.com. Present address: School of Forestry and Environmental Studies, Yale University, New Haven, CT"
      num: "*"
    - name: "Present address: Department of Aquaculture and Fish Biology, Hólar University, Skagafjörður, Iceland"
      num: "†"
    - name: "Co-first authors"
      num: "§"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))

# load packages
suppressPackageStartupMessages({
    library(mtf)
    library(tidyverse)
    library(grid)
    library(parallel)
    library(cowplot)
    library(egg)
})

# This sets plotting device on LAN computer:
if (!isTRUE(getOption('knitr.in.progress')) && file.exists(".Rprofile")) {
  source(".Rprofile")
}

parlist <- par_estimates %>%
        filter(V==1, H==1, X==1, iI == 10) %>%
        as.list()

V_gain <- function(V, D, aDV = parlist[["aDV"]]) {
    hD <- parlist[["hD"]]
    (aDV*D*V/(1 + aDV*hD*D)) / V
}

V_loss <- function(V, X, H, M, q, hM = parlist[["hM"]], .no_M_to_X = FALSE) {
    aX <- parlist[["aX"]]
    hX <- parlist[["hX"]]
    if (!.no_M_to_X) {
        Vl <- ((aX*V*X)/(1 + aX*hX*(V + H) + (aX * q)*hM*M)) / V
    } else {
        Vl <- ((aX*V*X)/(1 + aX*hX*(V + H))) / V
    }
    return(Vl)
}

H_gain <- function(P, H, aPH = parlist[["aPH"]]) {
    hP <- parlist[["hP"]]
    (aPH*P*H/(1 + aPH*hP*P)) / H
}

H_loss <- function(H, X, V, M, q, hM = parlist[["hM"]], .no_M_to_X = FALSE) {
    aX <- parlist[["aX"]]
    hX <- parlist[["hX"]]
    if (!.no_M_to_X) {
        Hl <- ((aX*H*X)/(1 + aX*hX*(V + H) + (aX * q)*hM*M)) / H
    } else {
        Hl <- (aX*H*X)/(1 + aX*hX*(V + H)) / H
    }
    return(Hl)
}

```



## Appendix S1






```{r figure-s1-sims}

supp_sims1 <- crossing(.aDV = c(par_estimates$aDV[1], par_estimates$aPH[1]),
         .aPH = c(par_estimates$aPH[1], par_estimates$aDV[1])) %>% 
    pmap_dfr(function(.aDV, .aPH) {
        food_web(tmax = 100, s = 10, b = 20, w = 20,
                 other_pars = list(q = 3, aDV = .aDV, aPH = .aPH)) %>%
            mutate(aDV = .aDV, aPH = .aPH)
        }) %>%
    spread(pool, N) %>%
    mutate(Vg = V_gain(detritivore, detritus, aDV = aDV),
           Hg = H_gain(plant, herbivore, aPH = aPH)) %>%
    select(-soil:-midge) %>%
    gather("variable", "value", Vg:Hg) %>%
    mutate(pool = factor(ifelse(grepl("^V", variable), "detritivore", "herbivore")),
           aDV = factor(aDV, levels = range(as.numeric(paste(aDV))),
                      labels = paste(c("low", "high"), "detritivore uptake")),
           aPH = factor(aPH, levels = range(as.numeric(paste(aPH))),
                      labels = paste(c("low", "high"), "herbivore uptake"))) %>%
    select(-variable) %>%
    select(aDV, aPH, pool, everything()) %>%
    group_by(aDV, aPH, pool) %>%
    mutate(value = value - value[1]) %>%
    ungroup()
```



```{r figure-s1-caption}
s1_caption <- paste("Time series of the bottom-up",
                    "effects on detritivore and herbivore pools with (a,b) low and",
                    "(c,d) high herbivore uptake rates, and with (a,c) low and",
                    "(b,d) high detritivore uptake rates.",
                    "Parameter values are as in Table 1, with low $a_D = 0.012$,",
                    "low $a_P = 0.012$, high $a_D = 0.032$, high $a_P = 0.032$,",
                    "$w = 20$, $b = 20$, and $q = 3$.")
```



```{r figure-s1, fig.width=5, fig.height=4, fig.cap=s1_caption}

trans_p3 <- ggplot(data = NULL) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_line(data = supp_sims1,
              aes(time, value,
                  color = pool), size = 1, linetype = 1) +
    geom_text(data = crossing(time =  0, N = max(supp_sims1$value),
                              aDV = sort(unique(supp_sims1$aDV)),
                              aPH = sort(unique(supp_sims1$aPH))) %>% 
                  arrange(aPH, aDV) %>% 
                  mutate(labs = letters[1:4]),
              aes(time, N, label = labs), hjust = 0, vjust = 1, size = 12 / 2.835) +
    scale_y_continuous(expression("Bottom-up effect on pool (" * day^{-1} * ")" )) +
    scale_x_continuous("Time (days)") +
    scale_color_manual(values = color_pal()[1:2]) +
    geom_text(data = tibble(time =  c(   35,    28),
                            value = c(0.070, 0.007),
                            aDV = sort(unique(supp_sims1$aDV))[1],
                            aPH = sort(unique(supp_sims1$aPH))[1],
                            lab = c("detritivore", "herbivore")),
              aes(time, value, label = lab), color = color_pal()[1:2],
              hjust = 0, vjust = 0, lineheight = 0.75, size = 10 / 2.835, parse = TRUE) +
    facet_grid(aPH ~ aDV) +
    theme(legend.position = "none",
          strip.text = element_text(face = "plain", size = 11,
                                    margin = margin(b = 4, l = 4)),
          panel.spacing.x = unit(2.5, "lines"),
          strip.background = element_blank(),
          axis.text = element_text(size = 10, color = "black"),
          axis.title = element_text(size = 12)) +
    NULL
trans_p3

```















```{r figure-s2-caption}
s2_caption <- paste("Cumulative midge effect on total bottom-up control",
                    "(\"$BU_{total}$\"), total top-down control (\"$TD_{net}$\"),",
                    "top-down intensification, and",
                    "top-down alleviation as a function of total midge inputs.",
                    "Data are from herbivores.",
                    "Parameter values are as in Table 1, with",
                    "low $q = 0.8$,",
                    "high $q = 8$, low $h_M = 1.3$, high $h_M = 5.3$, $w = 20$, and",
                    "$b$ ranging from 0.1 to 23 to produce different total midge inputs.")
```


```{r figure-s2, fig.width=5, fig.height=5, fig.cap=s2_caption}

full_pulse_df <- read_csv(paste0("~/Box Sync/Iceland Food Web Model/Results/",
                                 "sim_combinations.csv.gz"),
                         col_types = cols(pool = "f", .default = "d"))

pulse_df <- full_pulse_df %>%
    filter(muM == par_estimates$muM[1],
           hM == par_estimates$hM[1],
           aDV == par_estimates$aDV[1],
           aPH == par_estimates$aPH[1]) %>%
    select(-muM, -hM, -aDV, -aPH)


pulse_df_s2 <- full_pulse_df %>%
    filter(aDV == par_estimates$aDV[1],
           aPH == par_estimates$aPH[1],
           pool == "soil",
           muM == median(muM),
           q %in% range(q),
           hM %in% range(hM)) %>%
    mutate(area = w * b,
           q = factor(q, levels = sort(unique(q)),
                      labels = sprintf("%s midge\nexploitation",
                                       c("low", "high"))),
           hM = factor(hM, levels = sort(unique(hM)),
                       labels = paste(c("low", "high"),
                                      "midge\nhandling time"))) %>%
    select(area, q, muM, hM,
           cum_pos_loss_H,
           cum_neg_loss_H,
           cum_gain_H) %>%
    mutate(cum_loss_H = cum_pos_loss_H + cum_neg_loss_H,
           # Changing to magnitudes
           cum_neg_loss_H = abs(cum_neg_loss_H)) %>%
    gather("variable", "value", cum_pos_loss_H:cum_loss_H) %>%
    mutate(direction = factor(ifelse(grepl("loss", variable), "top-down", "bottom-up")),
           type = factor(case_when(
               grepl("^cum_pos_loss", variable) ~ "TD intensification",
               grepl("^cum_neg_loss", variable) ~ "TD alleviation",
               grepl("^cum_loss_", variable) ~ "TD net",
               TRUE ~ "BU total"
           ), levels = c("BU total", "TD net",
                         "TD intensification", "TD alleviation"))) %>%
    select(-variable) %>%
    mutate(id = interaction(direction, type)) %>%
    filter(area < 500) %>%
    identity()




s2_labs <- list(bquote(italic('BU'['total'])),
                  bquote(italic('TD'['net'])),
                  bquote(italic('TD'['intensification'])),
                  bquote(italic('TD'['alleviation'])))



plot_s2 <- pulse_df_s2 %>%
    ggplot(aes(area, value)) +
    geom_hline(yintercept = 0, color = "gray80") +
    geom_line(aes(color = direction, linetype = type, group = id), size = 1) +
    geom_text(data = tibble(area =  0, value = max(pulse_df_s2$value),
                            hM = pulse_df_s2$hM %>% unique() %>%
                                sort() %>% rep(each = 2),
                            q = pulse_df_s2$q %>% unique() %>%
                                sort() %>% rep(2),
                            labs = letters[1:4]),
              aes(label = labs), hjust = 0, vjust = 1,
              size = 12 / 2.835) +
    facet_grid(hM ~ q) +
    scale_color_manual(NULL, values = c(color_pal()[2], "gray50"), guide = FALSE) +
    scale_linetype_manual(NULL, values = c(1, 1, 3:2),
                          breaks = c("BU total", "TD net",
                                     "TD intensification", "TD alleviation"),
                          labels = s2_labs) +
    guides(linetype = guide_legend(keywidth = 2, nrow = 2, keyheight = 0.6,
                                   override.aes = list(color = c(color_pal()[2],
                                                                 rep("gray50", 3))),
                                   byrow = TRUE)) +
    xlab(expression("Total midge input (" * g ~ N ~ m^{-2} * ")")) +
    scale_y_continuous("Total midge effect") + #, limits = c(0, 4.3)) +
    theme(strip.background = element_blank(),
          legend.background = element_blank(),
          legend.position = "top",
          legend.direction = "horizontal",
          legend.justification = "center",
          legend.box = "vertical",
          legend.title = element_text(size = 11, margin = margin(0,0,0,b=-4)),
          legend.text = element_text(size = 10, family = "CMU Serif"),
          strip.text.y = element_text(vjust = 1)) +
    NULL


plot_s2

```



\clearpage


## New figures


### Absolute N

This is figure 2 but with absolute N values, not relative to $N_0$.

```{r fig2-with-absolutes-caption}
fig2_abs_caption <- paste("Time series of N content among all six pools.",
                    "Lines indicate the N content at time $t$.",
                    "The lower black bar represents the duration of the midge N pulse.",
                    "Parameter values are as in Table 1, with predator exploitation",
                    "$q = 3$, pulse duration $w = 20$, and pulse rate $b = 50$.")
```



```{r fig2-with-absolutes, fig.width=6, fig.height=5, fig.cap=fig2_abs_caption}


middle_sim <- food_web(tmax = 100, s = 10, b = 50, w = 20,
                       other_pars = list(q = 3))


upper_levels <- c("detritivore", "herbivore", "predator")


# This just sets the bounds for the facets:
dummy_data <- tibble(time = 20,
                     pool = factor(rep(c("soil", "detritus", "plant", upper_levels),
                                       each = 2),
                                   levels = c("soil", "detritus", "plant", upper_levels)),
                     N = c(middle_sim %>%
                               filter(pool == "soil") %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(2),
                           middle_sim %>%
                               filter(pool %in% c("detritus", "plant")) %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(2 * 2),
                           middle_sim %>%
                               filter(pool %in% upper_levels) %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(3 * 2))) %>%
    group_by(pool) %>%
    mutate(N = N[1] * c(-0.1, 1)) %>% 
    ungroup()

trans_pS1 <- middle_sim %>%
    filter(pool != "midge") %>%
    mutate(pool = droplevels(pool)) %>%
    ggplot(aes(time, N)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_segment(data = tibble(time = 10, time2 = 10+20, N = 0),
                 aes(xend = time2, yend = N), size = 1.5) +
    geom_line(aes(color = pool), size = 1) +
    geom_blank(data = dummy_data) +
    scale_y_continuous(expression("Nitrogen" ~ (g ~ N ~ m^{-2}))) +
    scale_x_continuous("Time (days)") +
    facet_wrap(~ pool, nrow = 2, scales = "free") +
    scale_color_manual(values = color_pal()[c(4:6, 1:3)], guide = FALSE) +
    theme(panel.spacing = unit(1.5, "lines")) +
    geom_text(data = dummy_data %>% 
                  filter(N < 0, pool == "soil"),
              label = "pulse", size = 10 / 2.835, hjust = 0.5, vjust = 0,
              color = "black") +
    NULL
trans_pS1

```





\clearpage


### Return to equilibrium

This is running with no pulse, but with non-equilibrium starting values.

```{r start-not-at-equilibrium-caption}
nae_caption <- paste("Time series of proportional changes in N content among all six",
                     "pools with no midge pulse and when starting N content",
                     "($N_0$) was randomized.",
                     "We ran 20 repetitions, each with different random starting N",
                     "for each pool",
                     "[$N_0 \\sim \\text{Uniform}(0.5 \\: N_{eq}, \\; 1.5 \\: N_{eq})$].",
                     "Sub-panels separate repetitions.",
                     "Lines indicate the N content at time $t$ relative to the ",
                     "equilibrium value [i.e. $(N_t - N_{eq}) / N_{eq}$].",
                     "Points indicate the starting N content relative to the ",
                     "equilibrium value [i.e. $(N_0 - N_{eq}) / N_{eq}$].",
                     "Parameter values are as in Table 1.")
```



```{r start-not-at-equilibrium, fig.width=6, fig.height=6.75, fig.cap=nae_caption}


not_at_eq <- function(.r) {
    # Equilibrium Ns
    Neqs <- par_estimates %>%
        filter(V==1, H==1, X==1, iI == 10) %>%
        select(ends_with("eq")) %>% 
        as.list()
    rename_vec <- list(I = "soil", D = "detritus", P = "plant", V = "detritivore", 
                       H = "herbivore", X = "predator", M = "midge")
    names(Neqs) <- names(Neqs) %>% 
        gsub(pattern = "eq$", replacement = "") %>% 
        map_chr(~ rename_vec[[.x]])
    # Random starting Ns
    N0s <- par_estimates %>%
        filter(V==1, H==1, X==1, iI == 10) %>%
        select(ends_with("eq")) %>% 
        mutate_all(~ runif(1, .x * 0.5, .x * 1.5)) %>% 
        as.list()
    names(N0s) <- gsub("eq$", "0", names(N0s))
    .dd <- food_web(tmax = 100, s = 1000, b = 0, w = 0, other_pars = list(q = 3),
             pool_starts = N0s) %>%
        filter(pool != "midge") %>%
        mutate(pool = droplevels(pool),
               rep = .r) %>% 
        group_by(pool) %>% 
        mutate(rel_N = (N - Neqs[[pool[[1]]]]) / Neqs[[pool[[1]]]]) %>% 
        ungroup()
    
    return(.dd)
}

set.seed(1755669093)
nae_df <- map_dfr(1:20, not_at_eq) %>% 
    mutate(rep = factor(rep))


nae_p <- nae_df %>% 
    ggplot(aes(time, rel_N, color = pool)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_point(data = nae_df %>% 
                   filter(time == 0) %>% 
                   mutate(time = -5)) +
    geom_line(size = 0.5) +
    scale_y_continuous("Proportional change in N", breaks = c(-0.5, 0, 0.5)) +
    scale_x_continuous("Time (days)", breaks = c(0, 50, 100)) +
    facet_wrap(~ rep, ncol = 4) +
    scale_color_manual(NULL, values = color_pal()[c(4:6, 1:3)]) +
    theme(panel.spacing = unit(1.5, "lines"),
          strip.text = element_blank()) +
    NULL
nae_p

```



\clearpage

### Varying nutrient input and loss


This varies $i_I$ and $\mu_I$, the inorganic nutrient input rate and density-independent
loss of soil nutrients, respectively.


```{r vary-iI-muI-timeseries-caption}
vain_ts_caption <- paste("Time series of proportional changes in N content among all six",
                     "pools with varying values of $i_I$ and $\\mu_I$,",
                     "the inorganic nutrient input rate and density-independent",
                     "loss of soil nutrients, respectively.",
                     "Sub-panel labels indicate the values of each parameter, and",
                     "middle values are the defaults used in the main text.",
                     "Lines indicate the N content at time $t$ relative to the ",
                     "starting value [i.e. $(N_t - N_{0}) / N_{0}$].",
                     "Parameter values are as in Table 1, with",
                     "predator exploitation $q = 3$, pulse duration $w = 0$, and",
                     "pulse rate $b = 0$.")
```



```{r vary-iI-muI-timeseries, fig.width=6, fig.height=5.5, fig.cap=vain_ts_caption}


vary_iI_muI <- function(.iI, .muI) {
    pools <- equil_pools(iI = .iI, muI = .muI)
    sim <- food_web(tmax = 100, s = 10, b = 50, w = 20,
                    other_pars = list(q = 3, iI = .iI, muI = .muI), 
                    ep_obj = pools) %>%
        filter(pool != "midge") %>%
        mutate(pool = droplevels(pool)) %>% 
        group_by(pool) %>%
        mutate(N_rel = (N - N[1]) / (N[1])) %>%
        ungroup() %>% 
        mutate(iI = .iI, muI = .muI)
    return(sim)
}


vain_df <- crossing(.iI = c(5, 10, 20),
                    .muI = c(0.005, 0.01, 0.02)) %>% 
    pmap_dfr(vary_iI_muI) %>% 
    mutate_at(vars(iI, muI), factor) %>%
    mutate(mI = factor(muI, levels = levels(muI),
                       labels = paste("italic(mu[I]) ==", levels(muI))),
           iI = factor(iI, levels = levels(iI),
                       labels = paste("italic(i[I]) ==", levels(iI))))


vain_dummy <- vain_df %>% 
    group_by(iI, mI) %>% 
    filter(N_rel == max(N_rel)) %>% 
    ungroup() %>% 
    select(-pool, -N) %>% 
    mutate(time = 10,
           time2 = 10 + 20,
           N_rel = -0.1 * N_rel)

vain_p <- vain_df %>%
    ggplot(aes(time, N_rel)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_segment(data = vain_dummy,
                 aes(xend = time2, yend = N_rel), size = 1.5) +
    geom_line(aes(color = pool), size = 0.5) +
    scale_y_continuous("Proportional change in N") +
    scale_x_continuous("Time (days)") +
    facet_wrap(iI ~ mI, nrow = 3, scales = "free_y", labeller = label_parsed) +
    scale_color_manual(NULL, values = color_pal()[c(4:6, 1:3)]) +
    guides(color = guide_legend(override.aes = list(size = 1))) +
    theme(panel.spacing = unit(1, "lines"),
          strip.text = element_text(family = "CMU Serif")) +
    NULL
vain_p

```






```{r vary-iI-muI-equil-caption}
vain_equil_caption <- paste("Equilibrium N pool size for all six", 
                            "pools versus the the inorganic nutrient input rate ($i_I$).",
                            "Line type indicates the density-independent loss of soil",
                            "nutrients ($\\mu_I$).",
                            "Parameter values are as in Table 1.")
```



```{r vary-iI-muI-equil, fig.width=6, fig.height=4.5, fig.cap=vain_equil_caption}

vary_iI_muI_equil <- function(.) {
    Z <- equil_pools(iI = .$iI[1], muI = .$muI[1])
    mutate(Z[["vals"]], iI = .$iI[1], muI = .$muI[1])
}

# Takes ~12 sec with 4 threads
vain_equil_df <- crossing(iI = seq(0, 20, length.out = 61),
                          muI = c(0.005, 0.01, 0.02)) %>% 
    split(1:nrow(.)) %>% 
    mclapply(vary_iI_muI_equil, 
             mc.cores = parallel::detectCores()) %>% 
    bind_rows()

# This just sets the bounds for the facets:
vain_dummy_equil <- tibble(iI = 20,
                     pool = factor(c("soil", "detritus", "plant", upper_levels),
                                   levels = c("soil", "detritus", "plant", upper_levels)),
                     eq = c(700, 60, 60, 2, 2, 2))

vain_equil_p <- vain_equil_df %>% 
    mutate_at(vars(muI), factor) %>% 
    ggplot(aes(iI, eq)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_line(aes(color = pool, linetype = muI), size = 0.75) +
    geom_blank(data = vain_dummy_equil) +
    scale_y_continuous(expression("Equilibrium pool size (g N" ~ m^{-2} * ")")) +
    scale_x_continuous(expression(paste("Inorganic nutrient input rate",
                                        ~  "(" * g ~ N ~ m^{-2} ~ d^{-1} * ")"))) +
    facet_wrap(~ pool, nrow = 2, scales = "free_y") +
    scale_color_manual(NULL, values = color_pal()[c(4:6, 1:3)], guide = FALSE) +
    scale_linetype_manual("Density-independent\nloss of soil nutrients:", values = c(2, 1, 3)) +
    theme(panel.spacing = unit(1, "lines"), legend.position = "top") +
    NULL

vain_equil_p

```





### No detritivores and no herbivores

These are simulations with no herbivores or no detritivores

##### Fig 3

This is a version of figure 3 with no herbivores or detritivores


```{r no-H-V-fig3-caption}
nohv_fig3_caption <- paste("Time series of proportional changes in N content for detritivore",
                      "and herbivore pools with low and high predator exploitation of",
                      "midges (indicated by the left y-axis).",
                      "This is shown for when (A) no detritivores are present,",
                      "(B) both are present, and",
                      "(C) no herbivores are present.",
                      "The blue shaded regions represent the proportional change in",
                      "N for predators, which is indicated by the right y-axis.",
                      "Different y-axis scales are used to aid visualization of",
                      "the transient dynamics of the herbivores and detritivores,",
                      "which had a weaker response to the pulse than predators for",
                      "the selected parameter values.",
                      "The lower black bar represents the duration of the midge N pulse.",
                      "Parameter values are as in Table 1, with low exploitation",
                      "$q = 8 \\times 10^{-3}$, high exploitation $q = 8$,",
                      "pulse duration $w = 20$, and pulse rate $b = 20$.")
```



```{r no-H-V-fig3, fig.width=6, fig.height=6.5, fig.cap=nohv_fig3_caption}



do_nohv_fig3 <- function(.H, .V) {
    
    stopifnot(length(.H) == 1 && .H %in% 0L:1L)
    stopifnot(length(.V) == 1 && .V %in% 0L:1L)
    
    if (.H == 0 && .V == 0) {
        pools <- equil_pools(Heq = 0, Veq = 0)
    }
    if (.H == 0 && .V == 1) {
        pools <- equil_pools(Heq = 0)
    }
    if (.H == 1 && .V == 0) {
        pools <- equil_pools(Veq = 0)
    }
    if (.H == 1 && .V == 1) {
        pools <- NULL
    }
    
    sim <- map_dfr(c(8e-3, 8),
                   function(q_) {
                       food_web(tmax = 100, s = 10, b = 20, w = 20,
                                other_pars = list(q = q_),
                                ep_obj = pools) %>%
                           filter(pool %in% c(upper_levels, "midge")) %>%
                           mutate(pool = droplevels(pool),
                                  q = q_)
                   }) %>%
        mutate_at(vars(q), factor) %>%
        mutate(pool = factor(paste(pool), levels = c(upper_levels, "midge")),
               H = .H, V = .V)
    
    return(sim)
}


nohv_fig3_df <- crossing(.H = 0L:1L, .V = 0L:1L) %>% 
    filter(!(.H == 0 & .V == 0)) %>% 
    pmap_dfr(do_nohv_fig3) %>% 
    group_by(H, V, pool, q) %>%
    mutate(N_rel = (N - N[1]) / N[1]) %>%
    mutate(N_rel = ifelse(is.nan(N_rel), 0, N_rel)) %>%
    ungroup() %>%
        mutate(q = factor(q, levels = range(as.numeric(paste(q))),
                          labels = paste(c("low", "high"), "exploitation")))



nohv_fig3_plot <- function(.H, .V, 
                           .mult = 25.2, 
                           .ylims = c(-0.3011, 1.1)) {
    
    # .H = 1; .V = 0
    # .mult = 25.2; .ylims = c(-0.3011, 1.1)
    # rm(.H, .V, .mult, .ylims)
    
    .title <- case_when(.H == 0 & .V == 1 ~ "No herbivores",
                        .H == 1 & .V == 0 ~ "No detritivores",
                        .H == 1 & .V == 1 ~ "Both present",
                        TRUE ~ "ERROR")
    
    hv_combo <- nohv_fig3_df %>% 
        filter(H == .H, V == .V) %>% 
        select(-H, -V)
    
    hv_plot <- hv_combo %>%
        filter(!pool %in% c("midge", "predator")) %>%
        mutate(pool = droplevels(pool)) %>%
        ggplot(aes(time, N_rel)) +
        geom_hline(yintercept = 0, color = "gray70") +
        geom_segment(data = tibble(time = 10, time2 = 10+20, N_rel = -0.1),
                     aes(xend = time2, yend = N_rel), size = 1.5) +
        geom_ribbon(data = hv_combo %>%
                        filter(pool == "predator") %>%
                        mutate(N_rel = N_rel / .mult),
                    aes(ymin = 0, ymax = N_rel), fill = color_pal(0.5)[3]) +
        geom_line(aes(color = pool), size = 0.75) +
        scale_x_continuous("Time (days)") +
        scale_color_manual(NULL, values = color_pal()) +
        facet_grid( ~ q) +
        ggtitle(.title) +
        theme(legend.position = "none",
              strip.text.y = element_text(face = "plain", size = 10, angle = 270,
                                          margin = margin(l = 4)),
              strip.text.x = element_text(face = "plain", size = 10,
                                          margin = margin(b = 4)),
              panel.spacing.y = unit(0, "lines"),
              panel.spacing.x = unit(1.5, "lines"),
              plot.margin = margin(0,0,t=12,b=12),
              plot.title = element_text(size = 12, hjust = 0.5, face = "bold", 
                                        margin = margin(0,0,0,b = 10))) +
        scale_y_continuous("Proportional change in N", limits = .ylims,
                           breaks = c(0, 0.5, 1),
                           sec.axis = sec_axis(~ . * .mult,
                                               name = paste0("Proportional change in N\n",
                                                             "(predator)"),
                                               breaks = c(0, 10, 20))) +
        NULL

    if (.H == 1 && .V == 1) {
        
        hv_plot <- hv_plot +
            geom_text(data = tibble(pool = factor(upper_levels[upper_levels != 
                                                                   "predator"]),
                                    time =  c(92, 100),
                                    N_rel =     c(0.3, -0.1),
                                    q = factor(paste(rep("high", 2), "exploitation"),
                                               levels = paste(c("low", "high"), 
                                                              "exploitation"))),
                      aes(label = pool, color = pool), hjust = 1, size = 10 / 2.835) +
            geom_text(data = tibble(time = 20, N_rel = -0.15,
                                    q = factor("high exploitation",
                                               levels = paste(c("low", "high"), 
                                                              "exploitation"))),
                      label = "pulse", size = 10 / 2.835, hjust = 0.5, vjust = 1,
                      color = "black") +
            theme(axis.title.y = element_text(margin = margin(0,0,r=4,l=10)))
    } else {
        
        hv_plot <- hv_plot +
            theme(axis.title.y = element_blank())
        
    }
    
    if (.H == 1 && .V == 0) {
        
        hv_plot <- hv_plot + 
            geom_text(data = tibble(time =  65,
                                    N_rel =     0.8,
                                    q = factor("high exploitation",
                                               levels = paste(c("low", "high"), 
                                                              "exploitation"))),
                      label = "predator", color = color_pal()[3], hjust = 1, vjust = 1,
                      size = 10 / 2.835)
        
    }
    
    if (!(.H == 0 & .V == 1)) {
        hv_plot <- hv_plot + 
            theme(axis.title.x = element_blank(), axis.text.x = element_blank())
    } else {
        hv_plot <- hv_plot + 
            theme(axis.title.x = element_text(margin = margin(0,0,0,t=4)))
    }
    
    return(hv_plot)
    
}




nohv_fig3_plot_list <- crossing(.H = 0L:1L, .V = 0L:1L) %>%
    filter(!(.H == 0 & .V == 0)) %>% 
    .[c(2, 3, 1),] %>% 
    pmap(nohv_fig3_plot)


ggarrange(plots = nohv_fig3_plot_list, ncol = 1, labels = LETTERS[1:3], 
          label.args = list(gp = gpar(fontsize = 14, fontface =  "bold"), 
                            vjust = 2, hjust = -4))
```





##### Fig 4


This is a version of figure 4 with no herbivores or detritivores


```{r no-H-V-fig4-caption}
nohv_fig4_caption <- paste("Time series of the top-down (\"TD\") and bottom-up (\"BU\")",
                           "effects on detritivore and herbivore pools with low and",
                           "high predator exploitation of midges.",
                           "This is shown for when (A) no detritivores are present,",
                           "(B) both are present, and",
                           "(C) no herbivores are present.",
                           "The gray line indicates the top-down effects on both",
                           "detritivore and herbivore pools, as they are identical",
                           "in the model.",
                           "Parameter values are as in Table 1, with low exploitation",
                           "$q = 8 \\times 10^{-3}$, high exploitation $q = 8$,",
                           "pulse duration $w = 20$, and pulse rate $b = 20$.")
```



```{r no-H-V-fig4, fig.width=6, fig.height=6.5, fig.cap=nohv_fig4_caption}



do_nohv_fig4 <- function(.H, .V) {
    
    stopifnot(length(.H) == 1 && .H %in% 0L:1L)
    stopifnot(length(.V) == 1 && .V %in% 0L:1L)
    
    if (.H == 0 && .V == 0) {
        pools <- equil_pools(Heq = 0, Veq = 0)
    }
    if (.H == 0 && .V == 1) {
        pools <- equil_pools(Heq = 0)
    }
    if (.H == 1 && .V == 0) {
        pools <- equil_pools(Veq = 0)
    }
    if (.H == 1 && .V == 1) {
        pools <- NULL
    }
    
    sim <- map_dfr(c(8e-3, 8),
        function(q_) {
            food_web(tmax = 100, s = 10, b = 20, w = 20,
                     other_pars = list(q = q_),
                     ep_obj = pools) %>%
                mutate(q = q_)
        }) %>%
    spread(pool, N) %>%
    mutate(Vg = V_gain(detritivore, detritus),
           Vl = V_loss(detritivore, predator, herbivore, midge, q),
           Hg = H_gain(plant, herbivore),
           Hl = H_loss(herbivore, predator, detritivore, midge, q)) %>%
    select(-soil:-midge) %>%
    gather("variable", "value", Vg:Hl) %>%
    mutate(pool = factor(ifelse(grepl("^V", variable), "detritivore", "herbivore")),
           type = factor(ifelse(grepl("l$", variable), "top-down", "bottom-up")),
           q = factor(q, levels = range(as.numeric(paste(q))),
                       labels = paste(c("low", "high"), "exploitation"))) %>%
    select(-variable) %>%
    select(q, pool, type, everything()) %>%
    group_by(q, pool, type) %>%
    mutate(value = value - value[1]) %>%
    ungroup() %>% 
    mutate(H = .H, V = .V)
    
    return(sim)
}


nohv_fig4_df <- crossing(.H = 0L:1L, .V = 0L:1L) %>% 
    filter(!(.H == 0 & .V == 0)) %>% 
    pmap_dfr(do_nohv_fig4)



nohv_fig4_plot <- function(.H, .V, .ylims = c(-0.037, 0.144)) {
    
    .title <- case_when(.H == 0 & .V == 1 ~ "No herbivores",
                        .H == 1 & .V == 0 ~ "No detritivores",
                        .H == 1 & .V == 1 ~ "Both present",
                        TRUE ~ "ERROR")
    .td_pool <- ifelse(.V == 0, "herbivore", "detritivore")
    
    hv_combo <- nohv_fig4_df %>% 
        filter(H == .H, V == .V) %>% 
        select(-H, -V) %>% 
        mutate(value = ifelse(is.nan(value), 0, value))
    
    
    hv_plot <- ggplot(data = NULL) +
        geom_hline(yintercept = 0, color = "gray70") +
        geom_line(data = hv_combo %>% filter(type == "bottom-up"),
                  aes(time, value,
                      color = pool,
                      group = interaction(pool, type)), size = 1, linetype = 1) +
        geom_line(data = hv_combo %>% filter(type == "top-down", pool == .td_pool),
                  aes(time, value), size = 1, color = "gray60") +
        xlab("Time (days)") +
        ggtitle(.title) +
        scale_color_manual(values = color_pal()[1:2]) +
        facet_grid(~ q) +
        scale_y_continuous(expression("Effect on pool (" * day^{-1} * ")" ),
                           breaks = c(0, 0.06, 0.12),
                           limits = .ylims) +
        theme(legend.position = "none",
              strip.text = element_text(face = "plain", size = 11,
                                        margin = margin(b = 4)),
              panel.spacing.x = unit(2.5, "lines"),
              strip.background = element_blank(),
              axis.text = element_text(size = 10, color = "black"),
              axis.title = element_text(size = 12),
              plot.title = element_text(size = 12, hjust = 0.5, face = "bold", 
                                        margin = margin(0,0,0,0)))
    

    if (.H == 1 && .V == 1) {
        
        hv_plot <- hv_plot +
            geom_text(data = tibble(time =  c(  38,    16,    25),
                                    value = c(0.06, 0.034, -0.03),
                                    q = factor(paste(c("low","low","low"), "exploitation"),
                                               levels = levels(hv_combo$q)),
                                    lab = sprintf("italic(%s)",
                                                  c("'BU'['detritivore']", "'BU'['herbivore']",
                                                    "'TD'['both']"))),
                      aes(time, value, label = lab), color = c(color_pal()[1:2], "gray60"),
                      hjust = 0, vjust = 0, lineheight = 0.75, size = 10 / 2.835, parse = TRUE) +
            theme(axis.title.y = element_text(margin = margin(0,0,r=4,l=10)))
        
    } else {
        
        hv_plot <- hv_plot +
            theme(axis.title.y = element_blank())
        
    }
    
    if (!(.H == 0 & .V == 1)) {
        hv_plot <- hv_plot + 
            theme(axis.title.x = element_blank(), axis.text.x = element_blank())
    } else {
        hv_plot <- hv_plot + 
            theme(axis.title.x = element_text(margin = margin(0,0,0,t=4)))
    }
    
    return(hv_plot)
    
}


nohv_fig4_plot_list <- crossing(.H = 0L:1L, .V = 0L:1L) %>%
    filter(!(.H == 0 & .V == 0)) %>% 
    .[c(2, 3, 1),] %>% 
    pmap(nohv_fig4_plot)


ggarrange(plots = nohv_fig4_plot_list, ncol = 1, labels = LETTERS[1:3], 
          label.args = list(gp = gpar(fontsize = 14, fontface =  "bold"), 
                            vjust = 2, hjust = -4))
```







### Midges just to detritivores or herbivores

These are simulations where midges only go to predators or only to detritus.


When midges only go to predators, we changed the following:


$$
\frac{dD}{dt} = {\color{red} \cancel{(1 - l) \mu_M M} } + (1 - l) \sum_{j \in \{ P,V,H,X \}}{ (\mu_j + m_j j) j } - 
    \frac{ a_D D V }{1 + a_D h_D D} - \mu_D D
$$


$\frac{dM}{dt}$ remains the same (i.e. it retains the $- \mu_M M$ term) so that 
midges do not build up indefinitely.



When midges only go to detritus, we changed the following:


\begin{align*}
\frac{dV}{dt} &= \frac{ a_D D V }{ 1 + a_D h_D D } - \frac{a_X V X }{ 1 + a_X h_X H + a_X h_X V {\color{red} \cancel{+ q a_X h_M M}} } - (\mu_V + m_V V) V \\
\frac{dH}{dt} &= \frac{ a_P P H }{ 1 + a_P h_P P } - \frac{a_X H X }{ 1 + a_X h_X H + a_X h_X V + {\color{red} \cancel{q a_X h_M M}} } - (\mu_H + m_H H) H \\
\frac{dX}{dt} &= \frac{ (a_X V + a_X H {\color{red} \cancel{+ q a_X M}}) X }{ 1 + a_X h_X H + a_X h_X V {\color{red} \cancel{+ q a_X h_M M}} } - (\mu_X + m_X X) X \\
\frac{dM}{dt} &= i_{M(t)} {\color{red} \cancel{- \frac{q a_X M X }{ 1 + a_X h_X H + a_X h_X V + q a_X h_M M }}} - \mu_M M
\end{align*}





##### Fig 3

This is a version of figure 3 where midges only go to predators or only to detritus


```{r M-to-one-pool-fig3-caption}
mtop_fig3_caption <- paste("Time series of proportional changes in N content for detritivore",
                      "and herbivore pools with low and high predator exploitation of",
                      "midges (indicated by the left y-axis).",
                      "This is shown for when (A) midges only go to the detritus pool,",
                      "(B) midges go to both detritus and predator pools, and",
                      "(C) midges only go to the predator pool.",
                      "The blue shaded regions represent the proportional change in",
                      "N for predators, which is indicated by the right y-axis.",
                      "Different y-axis scales are used to aid visualization of",
                      "the transient dynamics of the herbivores and detritivores,",
                      "which had a weaker response to the pulse than predators for",
                      "the selected parameter values.",
                      "The lower black bar represents the duration of the midge N pulse.",
                      "Parameter values are as in Table 1, with low exploitation",
                      "$q = 8 \\times 10^{-3}$, high exploitation $q = 8$,",
                      "pulse duration $w = 20$, and pulse rate $b = 20$.")
```



```{r M-to-one-pool-fig3, fig.width=6, fig.height=6.5, fig.cap=mtop_fig3_caption}



do_mtop_fig3 <- function(.midges_not_to) {
    
    # .midges_not_to = "X"
    # rm(.midges_not_to)
    
    stopifnot(length(.midges_not_to) == 1 && .midges_not_to %in% c("none", "D", "X"))
    
    sim <- map_dfr(c(8e-3, 8),
                   function(q_) {
                       food_web(tmax = 100, s = 10, b = 20, w = 20,
                                other_pars = list(q = q_),
                                midges_not_to = .midges_not_to) %>%
                           filter(pool %in% c(upper_levels, "midge")) %>%
                           mutate(pool = droplevels(pool),
                                  q = q_)
                   }) %>%
        mutate_at(vars(q), factor) %>%
        mutate(pool = factor(paste(pool), levels = c(upper_levels, "midge")),
               not_to = .midges_not_to)
    
    return(sim)
}


mtop_fig3_df <- tibble(.midges_not_to = c("X", "none", "D")) %>% 
    pmap_dfr(do_mtop_fig3) %>%
    group_by(not_to, pool, q) %>%
    mutate(N_rel = (N - N[1]) / N[1]) %>%
    mutate(N_rel = ifelse(is.nan(N_rel), 0, N_rel)) %>%
    ungroup() %>%
    mutate(q = factor(q, levels = range(as.numeric(paste(q))),
                      labels = paste(c("low", "high"), "exploitation")))



mtop_fig3_plot <- function(.midges_not_to, 
                           .mult = 3.5, 
                           .ylims = c(-0.3, 1.25)) {
    
    # .midges_not_to = "X"; .mult = 3.5; .ylims = c(-0.3, 1.25)
    # rm(.midges_not_to)
    
    .title <- case_when(.midges_not_to == "none" ~ "Midges to both",
                        .midges_not_to == "D" ~ "Midges to predators only",
                        .midges_not_to == "X" ~ "Midges to detritus only",
                        TRUE ~ "ERROR")
    
    mt_combo <- mtop_fig3_df %>% 
        filter(not_to == .midges_not_to) %>% 
        select(-not_to)
    
    
    
    mt_plot <- mt_combo %>%
        filter(!pool %in% c("midge", "predator")) %>%
        mutate(pool = droplevels(pool)) %>%
        ggplot(aes(time, N_rel)) +
        geom_hline(yintercept = 0, color = "gray70") +
        geom_segment(data = tibble(time = 10, time2 = 10+20, N_rel = -0.15),
                     aes(xend = time2, yend = N_rel), size = 1.5) +
        geom_ribbon(data = mt_combo %>%
                        filter(pool == "predator") %>%
                        mutate(N_rel = N_rel / .mult),
                    aes(ymin = 0, ymax = N_rel), fill = color_pal(0.5)[3]) +
        geom_line(aes(color = pool), size = 0.75) +
        scale_x_continuous("Time (days)") +
        scale_color_manual(NULL, values = color_pal()) +
        facet_grid( ~ q) +
        ggtitle(.title) +
        theme(legend.position = "none",
              strip.text.y = element_text(face = "plain", size = 10, angle = 270,
                                          margin = margin(l = 4)),
              strip.text.x = element_text(face = "plain", size = 10,
                                          margin = margin(b = 4)),
              panel.spacing.y = unit(0, "lines"),
              panel.spacing.x = unit(1.5, "lines"),
              plot.margin = margin(0,0,t=12,b=12),
              plot.title = element_text(size = 12, hjust = 0.5, face = "bold", 
                                        margin = margin(0,0,0,b = 10))) +
        scale_y_continuous("Proportional change in N", limits = .ylims,
                           breaks = c(0, 0.5, 1),
                           sec.axis = sec_axis(~ . * .mult,
                                               breaks = c(0, 2, 4),
                                               name = "Proportional change in N (predator)")) +
        NULL
    
    if (.midges_not_to == "none") {
        
        mt_plot <- mt_plot +
            geom_text(data = tibble(time =  65,
                                    N_rel =     1.2,
                                    q = factor("high exploitation",
                                               levels = paste(c("low", "high"), "exploitation"))),
                      label = "predator", color = color_pal()[3], hjust = 1, vjust = 1,
                      size = 10 / 2.835) +
            geom_text(data = tibble(pool = factor(upper_levels[upper_levels != "predator"]),
                                    time =  c(92, 100),
                                    N_rel =     c(0.3, -0.1),
                                    q = factor(paste(rep("high", 2), "exploitation"),
                                               levels = paste(c("low", "high"), "exploitation"))),
                      aes(label = pool, color = pool), hjust = 1, size = 10 / 2.835) +
            geom_text(data = tibble(time = 20, N_rel = -0.2,
                                    q = factor("high exploitation",
                                               levels = paste(c("low", "high"), "exploitation"))),
                      label = "pulse", size = 10 / 2.835, hjust = 0.5, vjust = 1,
                      color = "black") +
            theme(axis.title.y = element_text(margin = margin(0,0,r=4,l=10)))
    } else {
        
        mt_plot <- mt_plot +
            theme(axis.title.y = element_blank())
        
    }
    
    if (.midges_not_to != "D") {
        mt_plot <- mt_plot + 
            theme(axis.title.x = element_blank(), axis.text.x = element_blank())
    } else {
        mt_plot <- mt_plot + 
            theme(axis.title.x = element_text(margin = margin(0,0,0,t=4)))
    }
    
    return(mt_plot)
    
}




mtop_fig3_plot_list <- tibble(.midges_not_to = c("X", "none", "D")) %>% 
    pmap(mtop_fig3_plot)


ggarrange(plots = mtop_fig3_plot_list, ncol = 1, labels = LETTERS[1:3], 
          label.args = list(gp = gpar(fontsize = 14, fontface =  "bold"), 
                            vjust = 2, hjust = -4))
```





##### Fig 4


This is a version of figure 4 where midges only go to predators or only to detritus


```{r M-to-one-pool-fig4-caption}
mtop_fig4_caption <- paste("Time series of the top-down (\"TD\") and bottom-up (\"BU\")",
                           "effects on detritivore and herbivore pools with low and",
                           "high predator exploitation of midges.",
                           "This is shown for when (A) midges only go to the detritus pool,",
                           "(B) midges go to both detritus and predator pools, and",
                           "(C) midges only go to the predator pool.",
                           "The gray line indicates the top-down effects on both",
                           "detritivore and herbivore pools, as they are identical",
                           "in the model.",
                           "Parameter values are as in Table 1, with low exploitation",
                           "$q = 8 \\times 10^{-3}$, high exploitation $q = 8$,",
                           "pulse duration $w = 20$, and pulse rate $b = 20$.")
```



```{r M-to-one-pool-fig4, fig.width=6, fig.height=6.5, fig.cap=mtop_fig4_caption}

do_mtop_fig4 <- function(.midges_not_to) {
    
    stopifnot(length(.midges_not_to) == 1 && .midges_not_to %in% c("X", "none", "D"))
    
    sim <- map_dfr(c(8e-3, 8),
        function(q_) {
            food_web(tmax = 100, s = 10, b = 20, w = 20,
                     other_pars = list(q = q_),
                     midges_not_to = .midges_not_to) %>%
                mutate(q = q_)
        }) %>%
    spread(pool, N) %>%
    mutate(Vg = V_gain(detritivore, detritus),
           Vl = V_loss(detritivore, predator, herbivore, midge, q, 
                       .no_M_to_X = (.midges_not_to == "X")),
           Hg = H_gain(plant, herbivore),
           Hl = H_loss(herbivore, predator, detritivore, midge, q, 
                       .no_M_to_X = (.midges_not_to == "X"))) %>%
    select(-soil:-midge) %>%
    gather("variable", "value", Vg:Hl) %>%
    mutate(pool = factor(ifelse(grepl("^V", variable), "detritivore", "herbivore")),
           type = factor(ifelse(grepl("l$", variable), "top-down", "bottom-up")),
           q = factor(q, levels = range(as.numeric(paste(q))),
                       labels = paste(c("low", "high"), "exploitation"))) %>%
    select(-variable) %>%
    select(q, pool, type, everything()) %>%
    group_by(q, pool, type) %>%
    mutate(value = value - value[1]) %>%
    ungroup() %>% 
    mutate(not_to = .midges_not_to)
    
    return(sim)
}


mtop_fig4_df <- tibble(.midges_not_to = c("X", "none", "D")) %>% 
    pmap_dfr(do_mtop_fig4)

mtop_fig4_plot <- function(.midges_not_to, .ylims = c(-0.037, 0.1)) {
    
    # .midges_not_to = "D"; .ylims = c(-0.037, 0.1)
    # rm(.midges_not_to, .ylims)
    
    
    .title <- case_when(.midges_not_to == "none" ~ "Midges to both",
                        .midges_not_to == "D" ~ "Midges to predators only",
                        .midges_not_to == "X" ~ "Midges to detritus only",
                        TRUE ~ "ERROR")
    
    
    .td_pool <- "detritivore"
    
    
    mt_combo <- mtop_fig4_df %>%
        filter(not_to == .midges_not_to) %>% 
        select(-not_to)
        
    
    
    mt_plot <- ggplot(data = NULL) +
        geom_hline(yintercept = 0, color = "gray70") +
        geom_line(data = mt_combo %>% filter(type == "bottom-up"),
                  aes(time, value,
                      color = pool,
                      group = interaction(pool, type)), size = 1, linetype = 1) +
        geom_line(data = mt_combo %>% filter(type == "top-down", pool == .td_pool),
                  aes(time, value), size = 1, color = "gray60") +
        xlab("Time (days)") +
        ggtitle(.title) +
        scale_color_manual(values = color_pal()[1:2]) +
        scale_y_continuous(expression("Effect on pool (" * day^{-1} * ")" ),
                           limits = .ylims, breaks = c(0, 0.05, 0.1)) +
        facet_grid(~ q) +
        theme(legend.position = "none",
              strip.text = element_text(face = "plain", size = 11,
                                        margin = margin(b = 4)),
              panel.spacing.x = unit(2.5, "lines"),
              strip.background = element_blank(),
              axis.text = element_text(size = 10, color = "black"),
              axis.title = element_text(size = 12),
              plot.title = element_text(size = 12, hjust = 0.5, face = "bold", 
                                        margin = margin(0,0,0,0)))
    

    if (.midges_not_to == "none") {
        
        mt_plot <- mt_plot +
            geom_text(data = tibble(time =  c(  38,    16,    25),
                                    value = c(0.06, 0.034, -0.02),
                                    q = factor(paste(c("low","low","low"),
                                                     "exploitation"),
                                               levels = levels(mt_combo$q)),
                                    lab = sprintf("italic(%s)",
                                                  c("'BU'['detritivore']",
                                                    "'BU'['herbivore']",
                                                    "'TD'['both']"))),
                      aes(time, value, label = lab), 
                      color = c(color_pal()[1:2], "gray60"),
                      hjust = 0, vjust = 0, lineheight = 0.75, size = 10 / 2.835, 
                      parse = TRUE) +
            theme(axis.title.y = element_text(margin = margin(0,0,r=4,l=10)))
        
    } else {
        
        mt_plot <- mt_plot +
            theme(axis.title.y = element_blank())
        
    }
    
    if (.midges_not_to != "D") {
        mt_plot <- mt_plot + 
            theme(axis.title.x = element_blank(), axis.text.x = element_blank())
    } else {
        mt_plot <- mt_plot +
            geom_segment(data = tibble(x = c(50, 37) + 8,
                                     xend = c(40, 22),
                                     y = c(0.05, -0.03) + c(0, 0.002),
                                     yend = y + c(-0.02, 0.01),
                                     # curve = 1,
                                    q = factor(paste(c("high","high"), "exploitation"),
                                               levels = levels(mt_combo$q))), 
                       aes(x, y, xend = xend, yend = yend), 
                       # curvature = 1, 
                       arrow = arrow(length = unit(0.3, "lines"))) +
            geom_text(data = tibble(lab = c("TD[intensification]", "TD[alleviation]"),
                                    time = c(50, 37) + 10,
                                    value = c(0.05, -0.03),
                                    hj = c(0, 0),
                                    q = factor(paste(c("high","high"), "exploitation"),
                                               levels = levels(mt_combo$q))), 
                      aes(time, value, label = lab, hjust = hj),
                      parse = TRUE, vjust = 0.5) +
            theme(axis.title.x = element_text(margin = margin(0,0,0,t=4)))
    }
    
    return(mt_plot)
    
}



mtop_fig4_plot_list <- tibble(.midges_not_to = c("X", "none", "D")) %>%  
    pmap(mtop_fig4_plot)


ggarrange(plots = mtop_fig4_plot_list, ncol = 1, labels = LETTERS[1:3], 
          label.args = list(gp = gpar(fontsize = 14, fontface =  "bold"), 
                            vjust = 2, hjust = -4))
```







##### Fig 5


This is a version of figure 5 where midges only go to predators or only to detritus


```{r M-to-one-pool-fig5-caption}
mtop_fig5_caption <- paste("Cumulative midge effect on total bottom-up control",
                           "(\"BU total\"), net top-down control (\"TD net\"),",
                           "top-down intensification, and top-down alleviation",
                           "as a function of total midge inputs.",
                           "This is shown for when (A) midges only go to the detritus pool,",
                           "(B) midges go to both detritus and predator pools, and",
                           "(C) midges only go to the predator pool.",
                           "The panels show different combinations of high and",
                           "low predator exploitation and handling times on midges.",
                           "Data are from detritivores; herbivores gave broadly",
                           "similar responses to the cumulative midge effects (Fig. S2).",
                           "Parameter values are as in Table 1, with",
                           "low exploitation $q = 0.8$,", 
                           "high exploitation $q = 8$,", 
                           "low midge handling time $h_M = 1.3$,", 
                           "high midge handling time $h_M = 5.3$,", 
                           "pulse duration $w = 20$, and", 
                           "pulse rate $b$ ranging from 0.1 to 23 to produce", 
                           "different total midge inputs.")
```



```{r M-to-one-pool-fig5, fig.width=6, fig.height=9, fig.cap=mtop_fig5_caption}


do_mtop_fig5 <- function(.midges_not_to) {
    
    # .midges_not_to = "none"
    # rm(.midges_not_to)
    
    stopifnot(length(.midges_not_to) == 1 && .midges_not_to %in% c("X", "none", "D"))
    
    
    .one_combo <- function(.q, .hM, .b) {
        
        # .q = 0.8; .hM = par_estimates$hM[1] * 0.5; .b = 0.1
        # rm(.q, .hM, .b)
        
        fw <- food_web(tmax = 500, s = 10, b = .b, w = 20, 
                       other_pars = list(hM = .hM, q = .q), 
                       midges_not_to = .midges_not_to)
        
        fw <- fw %>%
            spread(pool, N) %>%
            mutate(Vg = V_gain(detritivore, detritus),
                   Vl = V_loss(detritivore, predator, herbivore, midge, q = .q, hM = .hM,
                               .no_M_to_X = (.midges_not_to == "X")),
                   Hg = H_gain(plant, herbivore),
                   Hl = H_loss(herbivore, predator, detritivore, midge, q = .q, hM = .hM,
                               .no_M_to_X = (.midges_not_to == "X"))) %>%
            summarize(cum_pos_loss_V = sum(Vl[Vl > Vl[1]] - Vl[1]),
                      cum_pos_loss_H = sum(Hl[Hl > Hl[1]] - Hl[1]),
                      cum_neg_loss_V = sum(Vl[Vl < Vl[1]] - Vl[1]),
                      cum_neg_loss_H = sum(Hl[Hl < Hl[1]] - Hl[1]),
                      cum_gain_V = sum(Vg[Vg > Vg[1]] - Vg[1]),
                      cum_gain_H = sum(Hg[Hg > Hg[1]] - Hg[1])) %>%
            mutate(area = 20 * .b,
                   q = .q,
                   hM = .hM) %>%
            select(area, q, hM, everything()) %>%
            mutate(cum_loss_V = cum_pos_loss_V + cum_neg_loss_V,
                   cum_loss_H = cum_pos_loss_H + cum_neg_loss_H,
                   # Changing to magnitudes
                   cum_neg_loss_V = abs(cum_neg_loss_V),
                   cum_neg_loss_H = abs(cum_neg_loss_H)) %>%
            gather("variable", "value", cum_pos_loss_V:cum_loss_H) %>%
            mutate(pool = factor(ifelse(grepl("V$", variable), 
                                        "detritivore", "herbivore")),
                   direction = factor(ifelse(grepl("loss", variable), 
                                             "top-down", "bottom-up")),
                   type = case_when(grepl("^cum_pos_loss", variable) ~ 
                                        "TD intensification",
                                    grepl("^cum_neg_loss", variable) ~ 
                                        "TD alleviation",
                                    grepl("^cum_loss_", variable) ~ "TD net",
                                    grepl("^cum_gain_", variable) ~ "BU total",
                                    TRUE ~ NA_character_) %>% 
                       factor(levels = c("BU total", "TD net", 
                                         "TD intensification", "TD alleviation"))) %>%
            select(-variable) %>%
            mutate(id = interaction(direction, type))
        
        if (sum(is.na(fw$type)) > 0) stop("Error in processing `type` column.")
        
        return(fw)
        
    }
    

    out <- crossing(.q = c(0.8, 8), 
             .hM = par_estimates$hM[1] * c(0.5, 2),
             .b = seq(0.1, 23, length.out = 21)) %>% 
        pmap_dfr(.one_combo) %>%
        mutate(q = factor(q, levels = sort(unique(q)),
                          labels = sprintf("%s midge\nexploitation",
                                           c("low", "high"))),
               hM = factor(hM, levels = sort(unique(hM)),
                           labels = paste(c("low", "high"),
                                          "midge\nhandling time"))) %>%
        mutate(not_to = .midges_not_to)
    
    return(out)
}

# Takes ~24 sec using 3 threads
mtop_fig5_df <- mclapply(c("X", "none", "D"), do_mtop_fig5, 
                         mc.cores = min(3, parallel::detectCores())) %>%
    bind_rows()


mtop_fig5_plot <- function(.midges_not_to, .ylims = c(-0.688, 4.305), .pool = "detritivore") {
    
    fig5_labs <- list(bquote(italic('BU'['total'])),
                      bquote(italic('TD'['net'])),
                      bquote(italic('TD'['intensification'])),
                      bquote(italic('TD'['alleviation'])))
    
    # .midges_not_to = "D"; .ylims = c(-0.688, 4.305)
    # rm(.midges_not_to, .ylims)
    
    
    .title <- case_when(.midges_not_to == "none" ~ "Midges to both",
                        .midges_not_to == "D" ~ "Midges to predators only",
                        .midges_not_to == "X" ~ "Midges to detritus only",
                        TRUE ~ "ERROR")
    
    mt_combo <- mtop_fig5_df %>%
        filter(not_to == .midges_not_to) %>% 
        select(-not_to)
    
    mt_plot <- mt_combo %>%
        filter(pool == .pool) %>%
        ggplot(aes(area, value)) +
        geom_hline(yintercept = 0, color = "gray80") +
        geom_line(aes(color = direction, linetype = type, group = id), size = 1) +
        ggtitle(.title) +
        facet_grid(hM ~ q) +
        scale_color_manual(NULL, values = c(color_pal()[1], "gray60"), guide = FALSE) +
        scale_linetype_manual(NULL, values = c(1, 1, 3:2),
                              breaks = c("BU total", "TD net",
                                         "TD intensification", "TD alleviation"),
                              labels = fig5_labs) +
        guides(linetype = guide_legend(keywidth = 2, nrow = 2, keyheight = 0.6,
                                       override.aes = list(color = c(color_pal()[1],
                                                                     rep("gray60", 3))),
                                       byrow = TRUE)) +
        xlab(expression("Total midge input (" * g ~ N ~ m^{-2} * ")")) +
        scale_y_continuous("Total midge effect", limits = .ylims, breaks = c(0, 2, 4)) +
        theme(strip.background = element_blank(),
              legend.background = element_blank(),
              legend.position = "top",
              legend.direction = "horizontal",
              legend.justification = "center",
              legend.box = "vertical",
              legend.title = element_text(size = 11, margin = margin(0,0,0,b=-4)),
              legend.text = element_text(size = 10),
              strip.text.y = element_text(vjust = 1),
              plot.title = element_text(size = 12, hjust = 0.5, face = "bold", 
                                        margin = margin(0,0,0,0))) +
        NULL
        
    

    if (.midges_not_to == "none") {
        
        mt_plot <- mt_plot +
            theme(axis.title.y = element_text(margin = margin(0,0,0,r=12)))
        
    } else {
        
        mt_plot <- mt_plot +
            theme(axis.title.y = element_blank())
        
    }
    
    if (.midges_not_to != "D") {
        mt_plot <- mt_plot + 
            theme(axis.title.x = element_blank(), axis.text.x = element_blank())
    } else {
        mt_plot <- mt_plot +
            theme(axis.title.x = element_text(margin = margin(0,0,0,t=4)))
    }
    
    return(mt_plot)
    
}



mtop_fig5_plot_list <- tibble(.midges_not_to = c("X", "none", "D")) %>%  
    pmap(mtop_fig5_plot)

legend <- get_legend(
  # create some space below the legend
  mtop_fig5_plot_list[[1]] + theme(legend.box.margin = margin(0, 0, 0, b = 12))
)

# Remove legends from plots:
mtop_fig5_plot_list <- map(mtop_fig5_plot_list, ~ .x + theme(legend.position = "none"))

mtop_fig5_plot <- plot_grid(plotlist = mtop_fig5_plot_list, ncol = 1, 
                            labels = LETTERS[1:3], 
                            label_size = 14, label_fontface = "bold", 
                            label_x = 0.05, label_y = 0.9, align = "v")

plot_grid(legend, mtop_fig5_plot, ncol = 1, rel_heights = c(0.1, 1))

```









