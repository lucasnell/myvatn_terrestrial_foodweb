---
title: 'Supporting Information.'
subtitle: "``Transient top-down and bottom-up effects of resources pulsed to multiple trophic levels''"
date: ""
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{placeins}
fontsize: 12pt
geometry: margin=1in,letterpaper
documentclass: article
graphics: true
colorlinks: true
supplemental: true
mathspec: true
output:
    bookdown::pdf_document2:
        fig_caption: yes
        template: template.tex
        latex_engine: xelatex
        number_sections: false
        dev: cairo_pdf
author:
    - name: Matthew A. McCary
      nums: "1,*"
    - name: Joseph S. Phillips
      nums: "2,†"
    - name: Tanjona Ramiadantsoa
      nums: "2"
    - name: Lucas A. Nell
      nums: "2"
    - name: Amanda R. McCormick
      nums: "2"
    - name: Jamieson C. Botsch
      nums: "2"
affil:
    - name: "Department of Entomology, University of Wisconsin, Madison, WI 53706, USA"
      num: "1"
    - name: "Department of Integrative Biology, University of Wisconsin, Madison, WI 53706, USA"
      num: "2"
    - name: "Corresponding author.  Email: matt.mccary@gmail.com. Present address: School of Forestry and Environmental Studies, Yale University, New Haven, CT"
      num: "*"
    - name: "Present address: Department of Aquaculture and Fish Biology, Hólar University, Skagafjörður, Iceland"
      num: "†"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))

# load packages
suppressPackageStartupMessages({
    library(mtf)
    library(tidyverse)
    library(grid)
    library(parallel)
    library(cowplot)
    library(viridisLite)
})

parlist <- par_estimates %>%
        filter(V==1, H==1, R==1, iN == 10) %>%
        as.list()
```



## Appendix S1






```{r figure-s1-sims}

V_gain <- function(V, D, aDV) {
    hD <- parlist[["hD"]]
    (aDV*D*V/(1 + aDV*hD*D)) / V
}
H_gain <- function(P, H, aPH) {
    hP <- parlist[["hP"]]
    (aPH*P*H/(1 + aPH*hP*P)) / H
}


supp_sims1 <- crossing(.aDV = c(par_estimates$aDV[1], par_estimates$aPH[1]),
         .aPH = c(par_estimates$aPH[1], par_estimates$aDV[1])) %>% 
    pmap_dfr(function(.aDV, .aPH) {
        food_web(tmax = 100, s = 10, b = 20, w = 20,
                 other_pars = list(f = 3, aDV = .aDV, aPH = .aPH)) %>%
            mutate(aDV = .aDV, aPH = .aPH)
        }) %>%
    spread(pool, N) %>%
    mutate(Vg = V_gain(detritivore, detritus, aDV),
           Hg = H_gain(plant, herbivore, aPH)) %>%
    select(-soil:-midge) %>%
    gather("variable", "value", Vg:Hg) %>%
    mutate(pool = factor(ifelse(grepl("^V", variable), "detritivore", "herbivore")),
           aDV = factor(aDV, levels = range(as.numeric(paste(aDV))),
                      labels = paste(c("low", "high"), "detritivore uptake")),
           aPH = factor(aPH, levels = range(as.numeric(paste(aPH))),
                      labels = paste(c("low", "high"), "herbivore uptake"))) %>%
    select(-variable) %>%
    select(aDV, aPH, pool, everything()) %>%
    group_by(aDV, aPH, pool) %>%
    mutate(value = value - value[1]) %>%
    ungroup()
```



```{r figure-s1-caption}
s1_caption <- paste("Time series of the bottom-up",
                    "effects on detritivore and herbivore pools with (a,b) low and",
                    "(c,d) high herbivore uptake rates, and with (a,c) low and",
                    "(b,d) high detritivore uptake rates.",
                    "Parameter values are as in Table 1, with low $a_D = 0.012$,",
                    "low $a_P = 0.012$, high $a_D = 0.032$, high $a_P = 0.032$,",
                    "$w = 20$, $b = 20$, and $q = 3$.")
```



```{r figure-s1, fig.width=5, fig.height=4, fig.cap=s1_caption}

trans_p3 <- ggplot(data = NULL) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_line(data = supp_sims1,
              aes(time, value,
                  color = pool), size = 1, linetype = 1) +
    geom_text(data = crossing(time =  0, N = max(supp_sims1$value),
                              aDV = sort(unique(supp_sims1$aDV)),
                              aPH = sort(unique(supp_sims1$aPH))) %>% 
                  arrange(aPH, aDV) %>% 
                  mutate(labs = letters[1:4]),
              aes(time, N, label = labs), hjust = 0, vjust = 1, size = 12 / 2.835) +
    scale_y_continuous(expression("Bottom-up effect on pool (" * day^{-1} * ")" )) +
    scale_x_continuous("Time (days)") +
    scale_color_manual(values = color_pal()[1:2]) +
    geom_text(data = tibble(time =  c(   35,    30),
                            value = c(0.070, 0.01),
                            aDV = sort(unique(supp_sims1$aDV))[1],
                            aPH = sort(unique(supp_sims1$aPH))[1],
                            lab = c("detritivore", "herbivore")),
              aes(time, value, label = lab), color = color_pal()[1:2],
              hjust = 0, vjust = 0, lineheight = 0.75, size = 10 / 2.835, parse = TRUE) +
    facet_grid(aPH ~ aDV) +
    theme(legend.position = "none",
          strip.text = element_text(face = "plain", size = 11,
                                    margin = margin(b = 4, l = 4)),
          panel.spacing.x = unit(2.5, "lines"),
          strip.background = element_blank(),
          axis.text = element_text(size = 10, color = "black"),
          axis.title = element_text(size = 12)) +
    NULL
trans_p3

```















```{r figure-s2-caption}
s2_caption <- paste("Cumulative midge effect on total bottom-up control",
                    "(\"$BU_{total}$\"), total top-down control (\"$TD_{net}$\"),",
                    "top-down intensification, and",
                    "top-down alleviation as a function of total midge inputs.",
                    "Data are from herbivores.",
                    "Parameter values are as in Table 1, with",
                    "low $q = 0.8$,",
                    "high $q = 8$, low $h_M = 1.3$, high $h_M = 5.3$, $w = 20$, and",
                    "$b$ ranging from 0.1 to 23 to produce different total midge inputs.")
```


```{r figure-s2, fig.width=5, fig.height=5, fig.cap=s2_caption}

full_pulse_df <- read_csv(paste0("~/Box Sync/Iceland Food Web Model/Results/",
                                 "sim_combinations.csv.gz"),
                         col_types = cols(pool = "f", .default = "d"))

pulse_df <- full_pulse_df %>%
    filter(mM == par_estimates$mM[1],
           hM == par_estimates$hM[1],
           aDV == par_estimates$aDV[1],
           aPH == par_estimates$aPH[1]) %>%
    select(-mM, -hM, -aDV, -aPH)


pulse_df_s2 <- full_pulse_df %>%
    filter(aDV == par_estimates$aDV[1],
           aPH == par_estimates$aPH[1],
           pool == "soil",
           mM == median(mM),
           f %in% range(f),
           hM %in% range(hM)) %>%
    mutate(area = w * b,
           f = factor(f, levels = sort(unique(f)),
                      labels = sprintf("%s midge\nexploitation",
                                       c("low", "high"))),
           hM = factor(hM, levels = sort(unique(hM)),
                       labels = paste(c("low", "high"),
                                      "midge\nhandling time"))) %>%
    select(area, f, mM, hM,
           cum_pos_loss_H,
           cum_neg_loss_H,
           cum_gain_H) %>%
    mutate(cum_loss_H = cum_pos_loss_H + cum_neg_loss_H,
           # Changing to magnitudes
           cum_neg_loss_H = abs(cum_neg_loss_H)) %>%
    gather("variable", "value", cum_pos_loss_H:cum_loss_H) %>%
    mutate(direction = factor(ifelse(grepl("loss", variable), "top-down", "bottom-up")),
           type = factor(case_when(
               grepl("^cum_pos_loss", variable) ~ "TD intensification",
               grepl("^cum_neg_loss", variable) ~ "TD alleviation",
               grepl("^cum_loss_", variable) ~ "TD net",
               TRUE ~ "BU total"
           ), levels = c("BU total", "TD net",
                         "TD intensification", "TD alleviation"))) %>%
    select(-variable) %>%
    mutate(id = interaction(direction, type)) %>%
    filter(area < 500) %>%
    identity()




s2_labs <- list(bquote(italic('BU'['total'])),
                  bquote(italic('TD'['net'])),
                  bquote(italic('TD'['intensification'])),
                  bquote(italic('TD'['alleviation'])))



plot_s2 <- pulse_df_s2 %>%
    ggplot(aes(area, value)) +
    geom_hline(yintercept = 0, color = "gray80") +
    geom_line(aes(color = direction, linetype = type, group = id), size = 1) +
    geom_text(data = tibble(area =  0, value = max(pulse_df_s2$value),
                            hM = pulse_df_s2$hM %>% unique() %>%
                                sort() %>% rep(each = 2),
                            f = pulse_df_s2$f %>% unique() %>%
                                sort() %>% rep(2),
                            labs = letters[1:4]),
              aes(label = labs), hjust = 0, vjust = 1,
              size = 12 / 2.835) +
    facet_grid(hM ~ f) +
    scale_color_manual(NULL, values = c(color_pal()[2], "gray50"), guide = FALSE) +
    scale_linetype_manual(NULL, values = c(1, 1, 3:2),
                          breaks = c("BU total", "TD net",
                                     "TD intensification", "TD alleviation"),
                          labels = s2_labs) +
    guides(linetype = guide_legend(keywidth = 2, nrow = 2, keyheight = 0.6,
                                   override.aes = list(color = c(color_pal()[2],
                                                                 rep("gray50", 3))),
                                   byrow = TRUE)) +
    xlab(expression("Total midge input (" * g ~ N ~ m^{-2} * ")")) +
    scale_y_continuous("Total midge effect") + #, limits = c(0, 4.3)) +
    theme(strip.background = element_blank(),
          legend.background = element_blank(),
          legend.position = "top",
          legend.direction = "horizontal",
          legend.justification = "center",
          legend.box = "vertical",
          legend.title = element_text(size = 11, margin = margin(0,0,0,b=-4)),
          legend.text = element_text(size = 10),
          strip.text.y = element_text(vjust = 1)) +
    NULL


plot_s2

```



\clearpage


## New figures




This is figure 2 but with absolute values, not relative to $N_0$.

```{r fig2-with-absolutes-caption}
fig2_abs_caption <- paste("Time series of N content among all six pools.",
                    "Lines indicate the N content at time $t$.",
                    "The lower black bar represents the duration of the midge N pulse.",
                    "Parameter values are as in Table 1, with predator exploitation",
                    "$q = 3$, pulse duration $w = 20$, and pulse rate $b = 50$.")
```



```{r fig2-with-absolutes, fig.width=6, fig.height=5, fig.cap=fig2_abs_caption}


middle_sim <- food_web(tmax = 100, s = 10, b = 50, w = 20,
                       other_pars = list(f = 3))


upper_levels <- c("detritivore", "herbivore", "predator")


# This just sets the bounds for the facets:
dummy_data <- tibble(time = 20,
                     pool = factor(rep(c("soil", "detritus", "plant", upper_levels),
                                       each = 2),
                                   levels = c("soil", "detritus", "plant", upper_levels)),
                     N = c(middle_sim %>%
                               filter(pool == "soil") %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(2),
                           middle_sim %>%
                               filter(pool %in% c("detritus", "plant")) %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(2 * 2),
                           middle_sim %>%
                               filter(pool %in% upper_levels) %>%
                               .[["N"]] %>%
                               max() %>%
                               rep(3 * 2))) %>%
    group_by(pool) %>%
    mutate(N = N[1] * c(-0.1, 1)) %>% 
    ungroup()

trans_pS1 <- middle_sim %>%
    filter(pool != "midge") %>%
    mutate(pool = droplevels(pool)) %>%
    ggplot(aes(time, N)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_segment(data = tibble(time = 10, time2 = 10+20, N = 0),
                 aes(xend = time2, yend = N), size = 1.5) +
    geom_line(aes(color = pool), size = 1) +
    geom_blank(data = dummy_data) +
    scale_y_continuous(expression("Nitrogen" ~ (g ~ N ~ m^{-2}))) +
    scale_x_continuous("Time (days)") +
    facet_wrap(~ pool, nrow = 2, scales = "free") +
    scale_color_manual(values = color_pal()[c(4:6, 1:3)], guide = FALSE) +
    theme(panel.spacing = unit(1.5, "lines")) +
    geom_text(data = dummy_data %>% 
                  filter(N < 0, pool == "soil"),
              label = "pulse", size = 10 / 2.835, hjust = 0.5, vjust = 0,
              color = "black") +
    NULL
trans_pS1

```





\clearpage



This is running with no pulse,but with non-equilibrium starting values.

```{r start-not-at-equilibrium-caption}
nae_caption <- paste("Time series of proportional changes in N content among all six",
                     "pools with no midge pulse and when starting at random N contents.",
                     "We ran 20 repetitions, each with different random starting N,",
                     "and sub-panels separate repetitions.",
                     "Lines indicate the N content at time $t$ relative to the ",
                     "equilibrium value [i.e. $(N_t - N_{eq}) / N_{eq}$].",
                     "Points indicate the starting N content relative to the ",
                     "equilibrium value [i.e. $(N_0 - N_{eq}) / N_{eq}$].",
                     "Parameter values are as in Table 1, with",
                     "predator exploitation $q = 3$, pulse duration $w = 0$, and",
                     "pulse rate $b = 0$.")
```



```{r start-not-at-equilibrium, fig.width=6, fig.height=7, fig.cap=nae_caption}


not_at_eq <- function(.r) {
    # Equilibrium Ns
    Neqs <- par_estimates %>%
        filter(V==1, H==1, R==1, iN == 10) %>%
        select(ends_with("eq")) %>% 
        as.list()
    rename_vec <- list(N = "soil", D = "detritus", P = "plant", V = "detritivore", 
                       H = "herbivore", R = "predator", M = "midge")
    names(Neqs) <- names(Neqs) %>% 
        gsub(pattern = "eq$", replacement = "") %>% 
        map_chr(~ rename_vec[[.x]])
    # Random starting Ns
    N0s <- par_estimates %>%
        filter(V==1, H==1, R==1, iN == 10) %>%
        select(ends_with("eq")) %>% 
        mutate_all(~ runif(1, .x * 0.5, .x * 1.5)) %>% 
        as.list()
    names(N0s) <- gsub("eq$", "0", names(N0s))
    .dd <- food_web(tmax = 100, s = 1000, b = 0, w = 0, other_pars = list(f = 3),
             pool_starts = N0s) %>%
        filter(pool != "midge") %>%
        mutate(pool = droplevels(pool),
               rep = .r) %>% 
        group_by(pool) %>% 
        mutate(rel_N = (N - Neqs[[pool[[1]]]]) / Neqs[[pool[[1]]]]) %>% 
        ungroup()
    
    return(.dd)
}

set.seed(1755669093)
nae_df <- map_dfr(1:20, not_at_eq) %>% 
    mutate(rep = factor(rep))


nae_p <- nae_df %>% 
    ggplot(aes(time, rel_N, color = pool)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_point(data = nae_df %>% 
                   filter(time == 0) %>% 
                   mutate(time = -5)) +
    geom_line(size = 0.75) +
    ylab("Proportional change in N") +
    xlab("Time (days)") +
    facet_wrap(~ rep, ncol = 4) +
    scale_color_manual(NULL, values = color_pal()[c(4:6, 1:3)]) +
    theme(panel.spacing = unit(1.5, "lines"),
          strip.text = element_blank()) +
    NULL
nae_p

```



\clearpage



This varies $i_I$ and $\mu_I$, the inorganic nutrient input rate and density-independent
loss of soil nutrients, respectively.


```{r vary-iI-muI-caption}
vain_caption <- paste("Time series of proportional changes in N content among all six",
                     "pools with varying values of $i_I$ and $\\mu_I$,",
                     "the inorganic nutrient input rate and density-independent",
                     "loss of soil nutrients, respectively.",
                     "Sub-panel labels indicate the values of each parameter, and",
                     "middle values are the defaults used in the main text.",
                     "Lines indicate the N content at time $t$ relative to the ",
                     "starting value [i.e. $(N_t - N_{0}) / N_{0}$].",
                     "Parameter values are as in Table 1, with",
                     "predator exploitation $q = 3$, pulse duration $w = 0$, and",
                     "pulse rate $b = 0$.")
```



```{r vary-iI-muI, fig.width=6, fig.height=5.5, fig.cap=vain_caption}


vary_iN_mN <- function(.iN, .mN) {
    pools <- equil_pools(iN = .iN, mN = .mN)
    sim <- food_web(tmax = 100, s = 10, b = 50, w = 20,
                    other_pars = list(f = 3, iN = .iN, mN = .mN), 
                    ep_obj = pools) %>%
        filter(pool != "midge") %>%
        mutate(pool = droplevels(pool)) %>% 
        group_by(pool) %>%
        mutate(N_rel = (N - N[1]) / (N[1])) %>%
        ungroup() %>% 
        mutate(iN = .iN, mN = .mN)
    return(sim)
}


vain_df <- crossing(.iN = c(5, 10, 20),
                    .mN = c(0.005, 0.01, 0.02)) %>% 
    pmap_dfr(vary_iN_mN) %>% 
    mutate_at(vars(iN, mN), factor) %>%
    mutate(mI = factor(mN, levels = levels(mN),
                       labels = paste("italic(mu[I]) ==", levels(mN))),
           iI = factor(iN, levels = levels(iN),
                       labels = paste("italic(i[I]) ==", levels(iN))))


vain_dummy <- vain_df %>% 
    group_by(iI, mI) %>% 
    filter(N_rel == max(N_rel)) %>% 
    ungroup() %>% 
    select(-pool, -N) %>% 
    mutate(time = 10,
           time2 = 10 + 20,
           N_rel = -0.1 * N_rel)

vain_p <- vain_df %>%
    ggplot(aes(time, N_rel)) +
    geom_hline(yintercept = 0, color = "gray70") +
    geom_segment(data = vain_dummy,
                 aes(xend = time2, yend = N_rel), size = 1.5) +
    geom_line(aes(color = pool), size = 0.75) +
    scale_y_continuous("Proportional change in N") +
    scale_x_continuous("Time (days)") +
    facet_wrap(mI ~ iI, nrow = 3, scales = "free_y", labeller = label_parsed) +
    scale_color_manual(NULL, values = color_pal()[c(4:6, 1:3)]) +
    theme(panel.spacing = unit(1, "lines"),
          strip.text = element_text(family = "CMU Serif")) +
    NULL
vain_p

```



